Ext.define("Ext.srm.ux.UxComboGrid",{extend:"Ext.form.field.Picker",alias:"widget.uxcombogrid",xtype:"uxcombogrid",alternateClassName:["Ext.ux.form.UxComboGrid"],requires:["Ext.ux.grid.GridPanel"],queryMode:"remote",autoSelect:true,triggerXType:null,enabletrigger:false,queryParam:null,parentObj:null,isQuery:true,config:{maxPickerWidth:200,maxPickerHeight:200,minPickerHeight:100,displayField:null,gridView:{height:200,minWidth:220,xtype:"uxgrid",floating:true,autoScroll:true,sm:false,rn:false,pageSize:0,store:null,cm:{defaultSortable:false,defaults:{width:100,menuDisabled:true},columns:[]}}},initComponent:function(){var C=this,D=Ext.isDefined,B,A=C.getGridView();B=C.queryMode==="local";if(!D(C.minChars)){C.minChars=B?0:1}A.store=Ext.applyIf({type:"ajax",autoLoad:false,reader:{type:"json",rootProperty:"records",totalProperty:"totalCount"}},A.store);C.gridView=A=Ext.create(A);C.store=A.getStore();C.callParent()},createPicker:function(){var A=this,B=A.gridView;A.gridPicker=B;B.on({scope:A,itemclick:A.onItemclick});return A.gridPicker},getParams:function(B){var A=this;var C={};Ext.apply(C,A.baseParams);if(!A.queryParam){A.queryParam="filter_LIKE_"+A.valueField}param=A.queryParam;if(param){C[param]=B}return C},onChange:function(C,B){var A=this;if(A.hasFocus){var D=A.gridPicker,E=D.getStore();A.callParent([C,B]);A.lastQuery="";A.grid;if(C){A.doRawQuery(C)}else{E.removeAll()}}},doRawQuery:function(A){var B=this;if(B.isQuery){B.doQuery(A,true)}},beforeQuery:function(B){var A=this;if(A.fireEvent("beforequery",B)===false){B.cancel=true}else{if(!B.cancel){if(B.query.length<A.minChars){B.cancel=true}}}return B},doQuery:function(D,A){var B=this,E=B.store,C=E.getFilters(),F=B.beforeQuery({lastQuery:B.lastQuery||"",query:D||"",rawQuery:A,cancel:false});if(F!==false&&!F.cancel){if(F.query===B.lastQuery){B.expand();B.afterQuery(F)}else{B.lastQuery=F.query;if(B.queryMode==="local"){B.doLocalQuery(F)}else{B.doRemoteQuery(F)}}return true}return false},doRemoteQuery:function(D){var B=this,A=function(){if(!B.destroyed){B.afterQuery(D)}};if(!B.readOnly&&!B.disabled){if(!B.isExpanded){B.expand()}}var C=B.getParams(D.query);B.fireEvent("triggerbaseparams",B,C,B.parentObj);B.store.load({params:C,limit:B.pageSize||10,start:0,callback:A})},afterQuery:function(B){var A=this;A.inputEl.focus();if(A.store.getCount()){A.doAutoSelect()}A.autoSize();A.alignPicker()},doAutoSelect:function(){var D=this,B=D.store,C=D.valueField,E=D.gridPicker,F;D.modalType="combo";if(E&&D.autoSelect&&B.getCount()==1){var G=B.getAt(0);if(G){D.isEnsureVisible=true;E.ensureVisible(G,{select:true});var A=G.get(C);D.selectRecord=G;D.fireEvent("select",D,A,G);D.fireEvent("triggerselect",D,A,G)}}},onSelect:function(H,F,A,G){var E=this,D=E.valueField,B=E.displayField;E.modalType="combo";if(E.isEnsureVisible===true){E.isEnsureVisible=false;return false}var C=F.get(D);E.setValue(C);E.selectRecord=F;E.fireEvent("select",E,C,F);E.fireEvent("triggerselect",E,C,F);E.onTabOut(H)},onItemclick:function(A,D){var B=this,C=B.valueField,E=B.gridPicker,G=E.getStore();B.modalType="combo";if(G.getCount()==1){var F=D.get(C);B.setValue(F);B.selectRecord=D;B.fireEvent("select",B,F,D);B.fireEvent("triggerselect",B,F,D);B.onTabOut(B)}},onTabOut:function(A){this.inputEl.focus();this.collapse()},onFocus:function(A){var B=this;B.callParent([A]);if(!B.readOnly&&!B.disabled){if(!B.isExpanded){if(B.selectWin&&B.selectWin.isHidden()===false){B.collapse()}else{B.expand();B.alignPicker()}}}},onClick:function(){console.info(me.selectWin)},expand:function(){var A=this,C,B,D;if(A.rendered&&!A.isExpanded&&!A.destroyed){A.isQuery=!(A.fireEvent("beforeexpand",A,A.parentObj)===false);if(!A.isQuery){return false}C=A.bodyEl;B=A.getPicker();D=Ext.getDoc();B.setMaxHeight(B.initialConfig.maxHeight);if(A.matchFieldWidth){B.setWidth(A.bodyEl.getWidth())}B.show(null,function(){A.inputEl.focus()});A.isExpanded=true;A.alignPicker();C.addCls(A.openCls);if(!A.ariaStaticRoles[A.ariaRole]){if(!A.ariaEl.dom.hasAttribute("aria-owns")){A.ariaEl.dom.setAttribute("aria-owns",B.listEl?B.listEl.id:B.el.id)}A.ariaEl.dom.setAttribute("aria-expanded",true)}A.touchListeners=D.on({translate:false,touchstart:A.collapseIf,scope:A,delegated:false,destroyable:true});A.scrollListeners=Ext.on({scroll:A.onGlobalScroll,scope:A,destroyable:true});Ext.on("resize",A.alignPicker,A,{buffer:1});A.fireEvent("expand",A);A.onExpand()}},onExpand:function(){var D=this,E=D.picker,B=D.gridPicker,A=B.getStore(),C=D.valueField,F=D.value,G;D.inputEl.focus();if(F){G=A.findRecord(C,F,0,true);if(G){D.isEnsureVisible=true;B.ensureVisible(G,{select:true})}}if(!Ext.isEmpty(D.getValue())){D.doRawQuery(D.getValue())}else{A.removeAll([])}D.isExpanded=true},onCollapse:function(){var B=this;B.isExpanded=false,picker=B.gridPicker,store=picker.getStore(),valueField=B.valueField;if(store.getCount()==0){B.reset()}else{if(store.getCount()>=1){var C=B.getValue();if(Ext.isEmpty(C)){B.autoSelectLastRecord()}else{var D=store.findRecord(valueField,C);if(Ext.isEmpty(D)){B.autoSelectLastRecord()}else{var A=D.get(valueField);if(C!=A){B.autoSelectLastRecord()}}}}}},autoSelectLastRecord:function(){var C=this;C.modalType="combo";var D=C.gridPicker,A=D.getStore(),B=C.valueField,F;if(Ext.isEmpty(C.selectRecord)){F=A.getAt(0);C.selectRecord=F}else{F=C.selectRecord}var E=F.get(B);C.suspendEvent("select");C.suspendEvent("change");C.setValue(E);C.resumeEvent("select");C.resumeEvent("change");C.fireEvent("select",C,E,F)},onTriggerClick:function(D,E,B){var C=this,A=C.enabletrigger;if(!C.readOnly&&!C.disabled){if(A){C.modalType="trigger";C.fireEvent("trigger",C)}else{if(C.isExpanded){C.collapse()}else{C.expand()}}}},setValue:function(B){var A=this;A.setRawValue(A.valueToRaw(B));return A.mixins.field.setValue.call(A,B)}});