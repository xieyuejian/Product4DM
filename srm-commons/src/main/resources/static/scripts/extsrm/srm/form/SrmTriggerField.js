Ext.define("Ext.srm.form.SrmTriggerField",{extend:"Ext.ux.form.TriggerField",alias:"srmTriggerField",xtype:"srmTriggerField",alternateClassName:["Ext.srm.form.SrmTriggerField"],selectWinClassName:"",triggerAction:"all",oldValue:{},enableKeyEvents:true,clearable:true,editable:false,singleSelect:true,multi:false,keypressParam:null,baseParams:{},baseParamsTree:{},renderToId:"",parentObj:null,parentXtype:"",selectWinCfg:{},gridCfg:{},fieldMapping:{},uniqueField:"",parentByType:null,getSelectWin:function(){var D=this;if(Ext.isEmpty(D.parentObj)){D.getParentObj()}D.dealFormMulti();var B;if(D.parentByType){B=D.parentObj.findParentByType(D.parentByType)}else{B=D.parentObj.findParentByType("window");if(!B){B=D.parentObj.findParentByType("panel")}}var C={renderTo:B.id||D.renderToId,singleSelect:true,baseParams:D.baseParams,baseParamsTree:D.baseParamsTree,select:function(G,H){if(D.multi===true){D.dealMultiValue(G)}else{if(!D.singleSelect&&H&&H.lenght>0){Ext.Array.each(H,function(I,J){D.dealComm(G,H)})}else{D.dealComm(G,H)}}}};Ext.apply(C,D.selectWinCfg||{});var E=Ext.create(D.selectWinClassName,C);var F=E.gridPanel;var A=E.gridPanel.getStore();A.on("beforeload",function(H,J,I){var G=H.proxy.extraParams;D.fireEvent("triggerbaseparams",D,G,D.parentObj);Ext.apply(H.proxy.extraParams,G)});if(D.multi===true){D.updateMultiValue(F);D.selectRecord(F)}return E},selectRecord:function(F){try{var D=this;var C=D.uniqueField;var E=F.getStore();var B=F.getSelectionModel();E.on("load",function(G,I){var J=D.uniqueField;var H=D.oldValue[D.uniqueField];var K=D.fieldMapping[J];Ext.Array.each(I,function(L,M){if(!Ext.isEmpty(H)&&H.indexOf(L.get(K))!=-1){B.select(L,true)}})})}catch(A){console.log(A)}},dealMultiValue:function(A){try{var D=this;var E=D.parentObj;if(D.isForm()){var C=E.getForm();Ext.Object.each(D.fieldMapping,function(J,G){var I=C.findField(J);if(I){if(D.oldValue[J]){var H=D.oldValue[J].join(",");I.setValue(H);D.fireEvent("aftersetvalue",D,D.oldValue,I,D.parentObj)}}else{if(!Ext.isIE){console.log("找不到"+J+"对象")}}})}else{var F=D.parentObj.getSelectionModel().getSelection();if(D.fieldMapping&&F&&F[0]){Ext.Object.each(D.fieldMapping,function(I,G){var H=D.oldValue[I].join(",");F[0].set(I,H)});D.fireEvent("aftersetvalue",D,D.oldValue,F[0],A,D.parentObj)}}}catch(B){console.log(B)}},updateMultiValue:function(C){try{var B=this;C.on("select",function(D,F,G,E){Ext.Object.each(B.fieldMapping,function(I,H){if(Ext.isEmpty(B.oldValue[I])){B.oldValue[I]=[F.get(H)]}else{if(!Ext.isEmpty(B.oldValue[I])&&B.oldValue[I].indexOf(F.get(H))==-1){Ext.Array.push(B.oldValue[I],F.get(H))}}})});C.on("deselect",function(D,F,G,E){Ext.Object.each(B.fieldMapping,function(I,H){if(!Ext.isEmpty(B.oldValue[I]&&B.oldValue[I].indexOf(F.get(H))!=-1)){Ext.Array.remove(B.oldValue[I],F.get(H))}})})}catch(A){console.info(A)}},dealFormMulti:function(){try{var C=this;var D=C.parentObj;if(C.isForm()){var B=D.getForm();Ext.Object.each(C.fieldMapping,function(I,F){var H=B.findField(I);if(H){var E=H.getValue();if(E){var G=E.split(",");if(Ext.isArray(G)&&G.length==0){G.push(E)}C.oldValue[I]=G;C.oldValue[I]=Ext.Array.unique(C.oldValue[I])}else{C.oldValue[I]=[]}}else{if(!Ext.isIE){console.log("找不到"+I+"对象")}}})}}catch(A){console.log(A)}},dealGridMulti:function(){try{var B=this;var C=B.parentObj;if(!B.isForm()){C.on("edit",function(E,D){var G=D.field;var F=D.record;if(G==B.dataIndex){Ext.Object.each(B.fieldMapping,function(K,H){var I=F.get(K);if(I){var J=I.split(",");if(Ext.isArray(J)&&J.length==0){J.push(I)}B.oldValue[K]=J;B.oldValue[K]=Ext.Array.unique(B.oldValue[K])}else{B.oldValue[K]=[]}})}})}else{}}catch(A){console.log(A)}},getParentObj:function(){var A=this;var B=null;if(!A.parentObj){A.parentObj=A.findParentByType(Ext.form.Panel);if(!A.parentObj){A.parentObj=A.findParentByType(Ext.grid.Panel);A.parentObj.on("edit",function(D,C){var E=C.field;if(A.editable&&E==A.dataIndex){if(C.value){A.editableDeal()}else{A.clearGrid(D,C)}}})}}if(A.parentObj){A.parentXtype=A.parentObj.getXType()}A.dealGridMulti()},isForm:function(){var A=this;var B=["form","fomrpanel","uxform","uxformpanel"];if(B.indexOf(A.parentXtype)!=-1){return true}else{return false}},isGrid:function(){var A=this;var B=["grid","uxgrid","uxgridpanel","uxeditorgrid","gridpanel"];if(B.indexOf(A.parentXtype)!=-1){A.parentObj.on("edit",function(D,C){var E=C.field;if(E==A.dataIndex){A.clearGrid(D,C)}});return true}else{return false}},dealComm:function(A,B){var C=this;if(C.isForm()){C.dealForm(A,B)}else{C.dealGrid(A,B)}C.fireEvent("triggerselect",A,B)},dealForm:function(A,B){var D=this;var C=D.parentObj.getForm();if(D.fieldMapping){Ext.Object.each(D.fieldMapping,function(G,E){var F=C.findField(G);if(F){F.setValue(B.get(E));D.fireEvent("aftersetvalue",D,F,D.parentObj)}else{if(!Ext.isIE){console.log("找不到"+G+"对象")}}})}},dealGrid:function(A,B){var D=this;try{var E=D.parentObj.getSelectionModel().getSelection();if(D.fieldMapping&&E&&E[0]){Ext.Object.each(D.fieldMapping,function(G,F){E[0].set(G,B.get(F))});D.fireEvent("aftersetvalue",D,B,E[0],A,D.parentObj)}}catch(C){console.log(C)}},clearForm:function(){var B=this;console.info(B);var A=B.parentObj.getForm();if(B.fieldMapping){Ext.Object.each(B.fieldMapping,function(E,C){var D=A.findField(E);if(D){D.reset()}else{if(!Ext.isIE){console.log("找不到"+E+"对象")}}})}},clearGrid:function(D,A){var F=this;var E=F.dataIndex;var H=A.grid;var G=A.record;var B=A.value;var C=A.field;if(Ext.isEmpty(B)){Ext.Object.each(F.fieldMapping,function(I,J){G.set(I,"")})}},editableDeal:function(){var C=this;if(C.hasListeners.triggerbeforeshow){if(!C.fireEvent("triggerbeforeshow",C,C.parentObj)){return false}}if(!C.keypressParam){if(!Ext.isIE){console.log("请配置回车请求参数配置项 如 keypressParam:'filter_EQ_XXXX'")}return false}else{if(!C.value){return false}}var A=C.getSelectWin();var D=A.gridPanel||A.grid;var B=A.gridPanel.getStore();B.on("beforeload",function(F,H,G){var E=F.proxy.extraParams;C.fireEvent("triggerbaseparams",C,E,C.parentObj);E[C.keypressParam]=C.value;Ext.apply(F.proxy.extraParams,E)});B.load({callback:function(F){if(Ext.isEmpty(F)){if(C.isForm()){var G=C.value;Q.tips($("common.notFindRecord")+C.fieldLabel+$("message.by")+G+$("message.recordMsg"),"E");C.clearForm()}else{if(C.isGrid()){var G=C.value;Q.tips($("common.notFindRecord")+C.column.text+$("message.by")+G+$("message.recordMsg"),"E");var E=C.parentObj.getSelectionModel().getSelection();if(E&&E[0]){E[0].set(C.dataIndex,"");C.parentObj.getView().refresh()}}}A.destroy()}else{if(F.length>0){C.dealComm(D,F[0]);A.destroy()}}}})},listeners:{trigger:function(B){var A=this;if(Ext.isEmpty(A.parentObj)){A.getParentObj()}if(B.disabled===false){if(A.hasListeners.triggerbeforeshow){if(!A.fireEvent("triggerbeforeshow",A,A.parentObj)){return false}}A.getSelectWin().show()}},"clear":function(){var B=this;if(B.isForm()){B.clearForm()}else{if(B.isGrid()){var A=B.parentObj.getSelectionModel().getSelection();if(A&&A[0]){A[0].set(B.dataIndex,"");B.parentObj.getView().refresh()}}}},"blur":function(){try{var B=this;if(B.editable){if(Ext.isEmpty(B.parentObj)){B.getParentObj()}B.editableDeal()}}catch(A){console.log(A)}},"keypress":function(A,B){var C=this;if(Ext.isEmpty(C.parentObj)){C.getParentObj()}if(B.getKey()==Ext.event.Event.ENTER&&C.editable){C.editableDeal()}}},constructor:function(B){var A=this;var B=B||{};this.callParent([B])}});