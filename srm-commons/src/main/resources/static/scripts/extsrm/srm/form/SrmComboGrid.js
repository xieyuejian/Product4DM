Ext.define("Ext.srm.form.SrmComboGrid",{extend:"Ext.ux.form.UxComboPage",alias:"widget.srmcombogrid",xtype:"srmcombogrid",alternateClassName:["Ext.srm.form.SrmComboGrid"],pageSize:10,oldValue:{},modalType:null,clearable:true,curSelected:null,autoFocusLoad:true,listConfig:{onItemClick:function(C){var A=this,D=A.pickerField,B,E;if(!D){return}B=D.valueField;E=A.getSelectionModel().getSelection();if(D.isForm()){if(!D.multiSelect&&C){D.dealComboForm(C)}}if(!D.multiSelect&&E.length){E=E[0];if(E&&D.isEqual(C.get(B),E.get(B))&&D.collapse){D.collapse()}}}},onTriggerClick:function(F,E,B){var C=this,D,A=C.enabletrigger;if(!C.readOnly&&!C.disabled){if(!Ext.isEmpty(E)&&A){var C=this;if(Ext.isEmpty(C.parentObj)){C.getParentObj()}if(C.hasListeners.triggerbeforeshow){if(!C.fireEvent("triggerbeforeshow",C,C.parentObj)){return false}}C.getSelectWin().show();C.modalType="trigger"}else{if(C.isExpanded){C.collapse()}else{if(B&&B.type==="keydown"&&B.altKey){D=C.autoSelect;C.autoSelect=false;C.expand();C.autoSelect=D}else{if(C.triggerAction==="all"){C.doQuery(C.allQuery,true)}else{if(C.triggerAction==="last"){C.doQuery(C.lastQuery,true)}else{C.doQuery(C.getRawValue(),false,true)}}}}C.modalType="combo"}}},getSelectWin:function(){var D=this;if(Ext.isEmpty(D.parentObj)){D.getParentObj()}D.dealFormMulti();var B;if(D.parentByType){B=D.parentObj.findParentByType(D.parentByType)}else{B=D.parentObj.findParentByType("window");if(!B){B=D.parentObj.findParentByType("panel")}}var C={renderTo:B.id||D.renderToId,singleSelect:true,baseParams:D.baseParams,baseParamsTree:D.baseParamsTree,select:function(G,H){D.fireEvent("triggerselect",D,G,H,D.parentObj);if(D.multi===true){D.dealMultiValue(G)}else{if(!D.singleSelect&&H&&H.lenght>0){Ext.Array.each(H,function(I,J){D.dealComm(G,H)})}else{D.dealComm(G,H)}}}};Ext.apply(C,D.selectWinCfg||{});var E=D.selectWin=Ext.create(D.selectWinClassName,C);var F=E.gridPanel;var A=E.gridPanel.getStore();A.on("beforeload",function(H,J,I){var G=H.proxy.extraParams;D.fireEvent("triggerbaseparams",D,G,D.parentObj);Ext.apply(H.proxy.extraParams,G)});if(D.multi===true){D.updateMultiValue(F);D.selectRecords(F)}return E},selectRecords:function(F){try{var D=this;var C=D.uniqueField;var E=F.getStore();var B=F.getSelectionModel();E.on("load",function(G,I){var J=D.uniqueField;var H=D.oldValue[D.uniqueField];var K=D.fieldMapping[J];Ext.Array.each(I,function(L,M){if(!Ext.isEmpty(H)&&H.indexOf(L.get(K))!=-1){B.select(L,true)}})})}catch(A){console.log(A)}},dealMultiValue:function(A){try{var D=this;var E=D.parentObj;if(D.isForm()){var C=E.getForm();Ext.Object.each(D.fieldMapping,function(J,G){var I=C.findField(J);if(I){if(D.oldValue[J]){var H=D.oldValue[J].join(",");I.setValue(H);D.fireEvent("aftersetvalue",D,D.oldValue,I,D.parentObj)}}else{if(!Ext.isIE){console.log("找不到"+J+"对象")}}})}else{var F=D.parentObj.getSelectionModel().getSelection();if(D.fieldMapping&&F&&F[0]){Ext.Object.each(D.fieldMapping,function(I,G){var H=D.oldValue[I].join(",");F[0].set(I,H)});D.fireEvent("aftersetvalue",D,D.oldValue,F[0],A,D.parentObj)}}}catch(B){console.log(B)}},updateMultiValue:function(C){try{var B=this;C.on("select",function(D,F,G,E){Ext.Object.each(B.fieldMapping,function(I,H){if(Ext.isEmpty(B.oldValue[I])){B.oldValue[I]=[F.get(H)]}else{if(!Ext.isEmpty(B.oldValue[I])&&B.oldValue[I].indexOf(F.get(H))==-1){Ext.Array.push(B.oldValue[I],F.get(H))}}})});C.on("deselect",function(D,F,G,E){Ext.Object.each(B.fieldMapping,function(I,H){if(!Ext.isEmpty(B.oldValue[I]&&B.oldValue[I].indexOf(F.get(H))!=-1)){Ext.Array.remove(B.oldValue[I],F.get(H))}})})}catch(A){console.info(A)}},dealFormMulti:function(){try{var C=this;var D=C.parentObj;if(C.isForm()){var B=D.getForm();Ext.Object.each(C.fieldMapping,function(I,F){var H=B.findField(I);if(H){var E=H.getValue();if(E){var G=E.split(",");if(Ext.isArray(G)&&G.length==0){G.push(E)}C.oldValue[I]=G;C.oldValue[I]=Ext.Array.unique(C.oldValue[I])}else{C.oldValue[I]=[]}}else{if(!Ext.isIE){console.log("找不到"+I+"对象")}}})}}catch(A){console.log(A)}},dealGridMulti:function(){try{var B=this;var C=B.parentObj;if(!B.isForm()){C.on("edit",function(E,D){var G=D.field;var F=D.record;if(G==B.dataIndex){Ext.Object.each(B.fieldMapping,function(K,H){var I=F.get(K);if(I){var J=I.split(",");if(Ext.isArray(J)&&J.length==0){J.push(I)}B.oldValue[K]=J;B.oldValue[K]=Ext.Array.unique(B.oldValue[K])}else{B.oldValue[K]=[]}})}})}else{}}catch(A){console.log(A)}},getParentObj:function(){var A=this;var B=null;if(A.column&&!A.parentObj){A.parentObj=A.column.findParentByType(Ext.grid.Panel);A.parentObj.on("edit",function(D,C){var E=C.field;if(A.editable&&E==A.dataIndex){if(C.value){if(A.modalType==="trigger"){A.editableDeal()}else{A.dealRecordGrid(D,C)}}else{A.clearGrid(D,C)}}})}else{A.parentObj=A.findParentByType(Ext.form.Panel);if(!A.parentObj){A.parentObj=A.findParentByType(Ext.grid.Panel)}}if(A.parentObj){A.parentXtype=A.parentObj.getXType()}A.dealGridMulti()},isForm:function(){var A=this;var B=["form","fomrpanel","uxform","uxformpanel"];if(B.indexOf(A.parentXtype)!=-1){return true}else{return false}},isGrid:function(){var A=this;var B=["grid","uxgrid","uxgridpanel","uxeditorgrid","gridpanel"];if(B.indexOf(A.parentXtype)!=-1){A.parentObj.on("edit",function(D,C){var E=C.field;if(E==A.dataIndex){A.clearGrid(D,C)}});return true}else{return false}},dealComm:function(A,B){var C=this;if(C.isForm()){C.dealForm(A,B)}else{if(C.modalType==="trigger"){C.dealGrid(A,B)}}},dealForm:function(A,B){var D=this;var C=D.parentObj.getForm();if(D.fieldMapping){D.triggerRecord=B.getData();Ext.Object.each(D.fieldMapping,function(G,E){var F=C.findField(G);if(F){F.setValue(B.get(E));F.fireEvent("aftersetvalue",D,B,F,D.parentObj,"form")}else{if(!Ext.isIE){console.log("找不到"+G+"对象")}}})}},dealGrid:function(A,B){var D=this;try{var E=D.parentObj.getSelectionModel().getSelection();if(D.fieldMapping&&E&&E[0]){Ext.Object.each(D.fieldMapping,function(G,F){E[0].set(G,B.get(F))});D.fireEvent("aftersetvalue",D,B,E[0],D.parentObj,"grid",A)}}catch(C){console.log(C)}},dealRecordGrid:function(G,A){var I=this,C=I.curSelected;try{var H=I.dataIndex;var K=A.grid;var J=A.record;var E=A.value;var F=A.field;if(H==F&&!Ext.isEmpty(E)){var B=I.store;var D=I.findRecordByDisplay(E);if(!D){D=I.findRecordByValue(E)}if(!D&&B.getCount()>0){if(!C&&I.autoSelect){var D=B.getAt(0);if(I.autoSelectLast){D=B.getAt(B.getCount()-1)}}C=null;J.set(H,D.get(I.fieldMapping[H]))}if(J&&D){Ext.Object.each(I.fieldMapping,function(L,M){if(M!=F){J.set(L,D.get(M))}});I.fireEvent("selfEdit",G,A);K.fireEvent("selfEdit",G,A)}}}catch(A){console.log(A)}},clearForm:function(C){var A=this;var B=A.parentObj.getForm();A.setValue(null);if(A.fieldMapping){Ext.Object.each(A.fieldMapping,function(F,D){var E=B.findField(F);if(E){E.reset();E.fireEvent("afterreset",A,E,A.parentObj)}else{if(!Ext.isIE){console.log("找不到"+F+"对象")}}})}},clearGrid:function(D,A){var F=this;var E=F.dataIndex;var H=A.grid;var G=A.record;var B=A.value;var C=A.field;if(Ext.isEmpty(B)){Ext.Object.each(F.fieldMapping,function(I,J){G.set(I,null)});F.fireEvent("afterreset",F,F.parentObj)}},editableDeal:function(){var C=this;if(C.hasListeners.triggerbeforeshow){if(!C.fireEvent("triggerbeforeshow",C,C.parentObj)){return false}}if(!C.keypressParam){if(!Ext.isIE){console.log("请配置回车请求参数配置项 如 keypressParam:'filter_EQ_XXXX'")}return false}else{if(!C.value){return false}}var A=C.getSelectWin();var D=A.gridPanel||A.grid;var B=A.gridPanel.getStore();B.on("beforeload",function(F,H,G){var E=F.proxy.extraParams;C.fireEvent("triggerbaseparams",C,E,C.parentObj);E[C.keypressParam]=C.value;Ext.apply(F.proxy.extraParams,E)});B.load({callback:function(F){if(Ext.isEmpty(F)){if(C.isForm()){var G=C.value;Q.tips($("common.notFindRecord")+C.fieldLabel+$("message.by")+G+$("message.recordMsg"),"E");C.clearForm()}else{if(C.isGrid()){var G=C.value;Q.tips($("common.notFindRecord")+C.column.text+$("message.by")+G+$("message.recordMsg"),"E");var E=C.parentObj.getSelectionModel().getSelection();if(E&&E[0]){E[0].set(C.dataIndex,"");C.parentObj.getView().refresh()}}}A.destroy()}else{if(F.length>0){C.dealComm(D,F[0]);A.destroy()}}}})},constructor:function(B){var A=this;A.clearable=Ext.isEmpty(B.clearable)?A.clearable:(B.clearable===true);if(A.clearable===true){B.triggers={clear:{cls:"x-form-trigger x-form-clear-trigger",weight:-1,handler:function(){A.suspendEvent("focus");A.clearComm();A.resumeEvent("focus")},onMouseDown:function(C){if(this.preventMouseDown){C.preventDefault()}}}}}Ext.applyIf(B.listeners,A.listeners);this.callParent([B]);A.getParentObj()},clearComm:function(){var B=this;if(B.isForm()){B.clearForm()}else{if(B.isGrid()){var A=B.parentObj.getSelectionModel().getSelection();if(A&&A[0]){Ext.Object.each(B.fieldMapping,function(C,D){A[0].set(C,"")});B.parentObj.getView().refresh();B.fireEvent("afterreset",B,B.parentObj)}}}},getParams:function(C){var A=this,D={},B=this.queryParam;if(B){D[B]=C}A.fireEvent("triggerbaseparams",A,D,A.parentObj);return D},expand:function(){var B=this,D,C,E;B.modalType="combo";if(B.rendered&&!B.isExpanded&&!B.destroyed){var A=B.fireEvent("beforeexpand",B,B.parentObj);if(A===false){return false}D=B.bodyEl;C=B.getPicker();E=Ext.getDoc();C.setMaxHeight(C.initialConfig.maxHeight);if(B.matchFieldWidth){C.setWidth(B.bodyEl.getWidth())}C.show();B.isExpanded=true;B.alignPicker();D.addCls(B.openCls);if(!B.ariaStaticRoles[B.ariaRole]){if(!B.ariaEl.dom.hasAttribute("aria-owns")){B.ariaEl.dom.setAttribute("aria-owns",C.listEl?C.listEl.id:C.el.id)}B.ariaEl.dom.setAttribute("aria-expanded",true)}B.touchListeners=E.on({translate:false,touchstart:B.collapseIf,scope:B,delegated:false,destroyable:true});B.scrollListeners=Ext.on({scroll:B.onGlobalScroll,scope:B,destroyable:true});Ext.on("resize",B.alignPicker,B,{buffer:1});B.fireEvent("expand",B);B.onExpand()}},doRemoteQuery:function(D){var B=this,A=function(){if(!B.destroyed){B.afterQuery(D)}};var C=B.expand();if(C===false){return false}if(B.pageSize){B.loadPage(1,{rawQuery:D.rawQuery,callback:A})}else{B.store.load({params:B.getParams(D.query),rawQuery:D.rawQuery,callback:A})}},dealComboForm:function(C){var A=this,D=A.picker;var B=A.parentObj.getForm();A.curSelected=C;if(A.fieldMapping&&C){Ext.Object.each(A.fieldMapping,function(G,E){var F=B.findField(G);if(F){F.setValue(C.get(E));F.fireEvent("aftercombosetvalue",A,C,F,A.parentObj)}else{if(Ext.isEmpty(F)){if(!Ext.isIE){console.log("找不到"+G+"对象")}}}});A.blur()}},doSetValue:function(V,S){var I=this,K=I.getStore(),J=K.getModel(),U=[],P=[],G=I.autoLoadOnValue,D=K.getCount()>0||K.isLoaded(),T=K.hasPendingLoad(),M=G&&!D&&!T,R=I.forceSelection,L=I.pickerSelectionModel,E=I.displayField===I.valueField,F=K.isEmptyStore,W=I.lastSelection,C,B,A,O,N,H;if(S&&!I.multiSelect){Ext.raise("Cannot add values to non multiSelect ComboBox")}if(T||M||!D||F){if(!V.isModel){if(S){I.value=Ext.Array.from(I.value).concat(V)}else{I.value=V}I.setHiddenValue(I.value);I.setRawValue(E?V:"");if(E&&!Ext.isEmpty(V)&&I.inputEl&&I.emptyText){I.inputEl.removeCls(I.emptyUICls)}}if(M&&!F){K.load()}if(!V.isModel||F){return I}}V=S?Ext.Array.from(I.value).concat(V):Ext.Array.from(V);for(C=0,B=V.length;C<B;C++){A=V[C];if(!A||!A.isModel){A=I.findRecordByValue(H=A);if(!A){A=I.valueCollection.find(I.valueField,H)}}if(!A){if(!R){if(!A&&V[C]){O={};O[I.displayField]=V[C];if(I.valueField&&(I.displayField!==I.valueField)){O[I.valueField]=V[C]}if(I.modalType==="trigger"){A=new J(I.triggerRecord)}else{A=new J(O)}}}else{if(I.valueNotFoundRecord){A=I.valueNotFoundRecord}}}if(A){U.push(A);P.push(A.get(I.valueField))}}if(W){B=W.length;if(B===U.length){for(C=0;!N&&C<B;C++){if(Ext.Array.indexOf(I.lastSelection,U[C])===-1){N=true}}}else{N=true}}else{N=U.length}if(N){I.suspendEvent("select");I.valueCollection.beginUpdate();if(U.length){L.select(U,false)}else{L.deselectAll()}I.valueCollection.endUpdate();I.resumeEvent("select")}else{I.updateValue()}return I},onCollapse:function(){var C=this,B=C.getPicker().getNavigationModel(),A=C.getStore(),E=C.curSelected;if(B){B.disable()}if(C.updatingValue){C.doQueryTask.cancel()}C.inputEl.dom.removeAttribute("aria-activedescendant");if(A.getCount()<=0){C.clearComm()}else{if(E!=C.pickerSelectionModel.getLastSelected()){E=null}if(!E&&C.autoSelect){var D=A.getAt(0);if(C.autoSelectLast){D=A.getAt(A.getCount()-1)}if(C.isForm()){if(C.getRawValue()){C.dealComboForm(D)}else{C.clearComm()}}}else{if(!E){C.clearComm()}}}},onFocus:function(A){var B=this;B.callParent([A]);if(B.autoFocusLoad){delete B.lastQuery;B.onTriggerClick(B,null,A)}else{if(B.triggerAction!=="all"&&B.queryFilter&&B.queryMode==="local"&&B.clearFilterOnBlur){delete B.lastQuery;B.doRawQuery()}}},config:{triggers:{picker:{handler:"onTriggerClick",scope:"this",focusOnMousedown:true,onMouseDown:function(A){if(this.preventMouseDown){A.preventDefault()}}}}}});